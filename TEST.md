# 电力网络分区智能体评估系统使用指南

> **简介**：本系统用于评估和对比不同电力网络分区方法的性能，包括我们的强化学习智能体与传统基线方法的对比。

## 📋 快速开始

### 运行测试
```bash
python test.py [选项]
```

### 测试模式
| 模式 | 命令 | 功能说明 |
|-----|------|---------|
| **基线对比** | `python test.py --baseline` | 在同一网络上与传统方法对比 |
| **泛化测试** | `python test.py --generalization` | 测试跨网络的泛化能力 |
| **完整评估** | `python test.py --comprehensive` | 基线对比 + 泛化测试 |

### 测试结果
- 📊 **可视化图表**：`evaluation_results/comparison_visualization.png`
- 📄 **详细报告**：`evaluation_results/evaluation_report.txt`

---

## 🎯 核心评估指标

### 指标概述
我们使用三个关键指标来评估电力网络分区的质量：

| 指标名称 | 作用 | 期望效果 |
|---------|------|----------|
| **负载平衡度** | 衡量各分区负荷是否均匀分布 | 🎯 负荷越均匀越好 |
| **电气解耦率** | 衡量分区间的电气连接是否最少 | 🎯 跨分区连线越少越好 |
| **功率平衡度** | 衡量分区内发电与负荷的匹配度 | 🎯 发电负荷越匹配越好 |

### 指标计算详解

#### 1. 负载平衡度 (Load Balance)
- **物理意义**：各分区的负荷分布是否均匀
- **计算方法**：变异系数（CV = 标准差/平均值）
- **取值范围**：[0, +∞)，越小越好
- **实际示例**：
  ```
  假设3个分区的负荷分别为：[100MW, 120MW, 80MW]
  平均值 = 100MW，标准差 = 16.33MW
  负载平衡度 = 16.33/100 = 0.163
  ```

#### 2. 电气解耦率 (Electrical Decoupling)
- **物理意义**：分区间的电气连接强度
- **计算方法**：跨分区线路数 / 总线路数
- **取值范围**：[0, 1]，越小越好
- **实际示例**：
  ```
  假设网络共有80条线路，其中12条跨越分区边界
  电气耦合率 = 12/80 = 0.15
  ```

#### 3. 功率平衡度 (Power Balance)
- **物理意义**：分区内发电与负荷的匹配程度
- **计算方法**：|发电-负荷|的和 / 总负荷
- **取值范围**：[0, +∞)，越小越好
- **实际示例**：
  ```
  分区1：发电150MW，负荷100MW，差值50MW
  分区2：发电80MW，负荷120MW，差值40MW
  分区3：发电70MW，负荷80MW，差值10MW
  功率不平衡 = (50+40+10)/300 = 0.33
  ```

---

## 📊 评分系统与提升率计算

### 评分转换
由于原始指标都是"越小越好"，为了便于比较，我们将其转换为"越大越好"的分数：

| 原始指标 | 转换公式 | 分数范围 |
|---------|----------|----------|
| 负载平衡度 | `Score = 1/(1 + CV)` | (0, 1] |
| 电气解耦率 | `Score = 1 - 耦合率` | [0, 1] |
| 功率平衡度 | `Score = 1/(1 + 不平衡率)` | (0, 1] |

### 综合评分
使用加权平均计算最终质量分数：
```
综合分数 = 0.4 × 负载平衡分数 + 0.4 × 电气解耦分数 + 0.2 × 功率平衡分数
```

### 提升率计算方法

**提升率** = (智能体分数 - 基线分数) / 基线分数 × 100%

**具体示例**：
```
场景：IEEE-57网络，正常负荷条件
- 我们的智能体综合分数：0.85
- 随机方法综合分数：0.60
- 提升率 = (0.85 - 0.60) / 0.60 × 100% = 41.7%

解读：我们的方法比随机方法好41.7%
```

**提升率含义**：
- **正值**：我们的方法更好
- **负值**：基线方法更好
- **数值大小**：改进的幅度

---

## 🔄 测试流程详解

### 1. 测试场景生成
系统会自动生成4种测试场景：

| 场景名称 | 场景描述 | 生成方式 |
|---------|----------|----------|
| **normal** | 正常负荷条件 | 使用原始网络数据 |
| **high_load** | 高负荷条件 | 所有负荷增加50% |
| **unbalanced** | 负荷不均衡 | 30%节点负荷增加80%，其余减少20% |
| **fault** | 线路故障 | 随机移除一条重要线路 |

### 2. 方法对比
每个场景下测试4种方法：

| 方法名称 | 说明 | 类型 |
|---------|------|------|
| **my_agent** | 我们的强化学习智能体 | 🤖 AI方法 |
| **random** | 随机分区 | 📊 基线方法 |
| **degree_based** | 基于节点度数的启发式 | 📊 基线方法 |
| **spectral** | 谱聚类方法 | 📊 基线方法 |

### 3. 重复实验
- 每种方法在每个场景下运行 **10次**
- 取平均值以减少随机性影响
- 确保结果的可靠性

---

## 📈 结果解读指南

### 可视化图表说明
生成的图表包含7个子图，分为两排：

**上排4图（分数类，越高越好）**：
1. 负载平衡分数对比
2. 电气解耦分数对比  
3. 功率平衡分数对比
4. 综合质量分数对比

**下排3图（原始指标，越低越好）**：
1. 负载平衡度（CV值）
2. 电气耦合率
3. 功率不平衡率

### 报告文件解读
`evaluation_report.txt` 包含详细的数值结果：

```
方法名称    场景      负载CV   耦合率   功率不平衡   综合分数   提升率
my_agent   normal    0.12     0.15     0.08        0.85      41.7%
random     normal    0.25     0.30     0.20        0.60      baseline
...
```

### 性能判断标准
- **优秀**：综合分数 > 0.8，提升率 > 30%
- **良好**：综合分数 > 0.7，提升率 > 20%
- **一般**：综合分数 > 0.6，提升率 > 10%
- **需改进**：综合分数 < 0.6，提升率 < 10%

---

## ⚙️ 高级配置

### 命令行自定义测试
除了使用预设的模式，你还可以通过命令行参数进行更精细的测试控制，这对于专项实验非常有用。

- **`--scenarios <场景1> <场景2> ...`**
    - **作用**: 指定一个或多个要运行的测试场景，此参数会覆盖 `mode` 设置中的场景配置。
    - **可选值**: `normal`, `high_load`, `unbalanced`, `fault`。
    - **示例**: `python test.py --baseline --scenarios normal fault --model ...`

- **`--runs <次数>`**
    - **作用**: 指定每个测试场景的运行次数，此参数会覆盖 `mode` 设置中的运行次数。
    - **示例**: `python test.py --baseline --runs 25 --model ...`

**组合使用示例**:
```bash
# 在ieee57网络上，仅在 "高负载" 和 "故障" 场景下测试，每种场景运行30次
python test.py --baseline \
               --network ieee57 \
               --scenarios high_load fault \
               --runs 30 \
               --model path/to/your/model.pth
```

### 权重调整
可以在配置文件中调整各指标的权重：
```yaml
metrics_weights_v2:
  load_balance: 0.4    # 负载平衡权重
  decoupling: 0.4      # 电气解耦权重  
  power_balance: 0.2   # 功率平衡权重
```

### 内置测试参数
- **重复次数**：默认10次（standard模式），可通过 `--runs` 参数覆盖。
- **分区数量**：≤57节点用3分区，>57节点用5分区。
- **最大步数**：智能体在每个回合中最多执行200步来优化分区。

---

## 🚨 常见问题

### Q1: 为什么有些场景下提升率为负？
**A**: 这是正常的。在某些特定场景下，简单的启发式方法可能表现更好，这提示我们需要针对该场景优化智能体。

### Q2: 综合分数的权重如何确定？
**A**: 当前权重基于电力系统的实际需求设定。负载平衡和电气解耦更重要（各占40%），功率平衡相对次要（20%）。

### Q3: 如何判断结果的可靠性？
**A**: 通过10次重复实验取平均值，并观察不同场景下的一致性。如果某个方法在所有场景下都表现优异，说明其鲁棒性强。

### Q4: 测试时间过长怎么办？
**A**: 可以减少重复次数或使用 `--baseline` 模式只进行基线对比，跳过泛化测试。

---

## 🔧 文件维护说明

### 当前文件结构
```
evaluation_results/
├── comparison_visualization.png    # 对比图表
└── evaluation_report.txt          # 详细报告
```

### 过时文件清理
- `code/test/evaluation_config.py` 中的旧版配置已不再使用
- 建议定期检查并清理未使用的配置项

### 未来改进方向
1. **交互式可视化**：迁移到Plotly实现动态图表
2. **更多指标**：考虑加入网络可靠性、稳定性等指标
3. **自动化报告**：生成更详细的分析报告和建议

---



# 在ieee57网络上，只测试normal和fault两种场景，每种场景运行20次
python test.py --baseline --network ieee57 --scenarios normal high_load unbalanced fault --runs 20 --model data/checkpoints/models/agent_ieee57_adaptive_20250706_193341_best.pth