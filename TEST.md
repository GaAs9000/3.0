# 电力网络分区智能体评估系统使用指南

> **简介**：本系统用于评估和对比不同电力网络分区方法的性能，包括我们的强化学习智能体与传统基线方法的对比。采用场景感知奖励系统和智能评估机制。

## 📋 快速开始

### 运行测试
```bash
python test.py [选项]
```

### 测试模式
| 模式 | 命令 | 功能说明 |
|-----|------|---------|
| **快速测试** | `python test.py --quick` | 快速性能验证（推荐） |
| **基线对比** | `python test.py --baseline` | 在同一网络上与传统方法对比 |
| **泛化测试** | `python test.py --generalization` | 测试跨网络的泛化能力 |
| **完整评估** | `python test.py --comprehensive` | 基线对比 + 泛化测试 |

### 网络兼容性
✅ **已验证支持**: IEEE14, IEEE30, IEEE57, IEEE118
- 自动适配不同规模网络的分区数量
- 统一的性能评估标准
- 跨网络泛化能力测试

### 测试结果
- 📊 **可视化图表**：`evaluation_results/comparison_visualization.png`
- 📄 **详细报告**：`evaluation_results/evaluation_report.txt`
- 📈 **交互式仪表板**：`output/dashboards/evaluation_*.html`

---

## 🎯 核心评估指标

### 指标概述
我们使用三个关键指标来评估电力网络分区的质量，结合场景感知评估：

| 指标名称 | 作用 | 期望效果 | 权重 |
|---------|------|----------|------|
| **负载平衡度** | 衡量各分区负荷是否均匀分布 | 🎯 负荷越均匀越好 | 40% |
| **电气解耦率** | 衡量分区间的电气连接是否最少 | 🎯 跨分区连线越少越好 | 40% |
| **功率平衡度** | 衡量分区内发电与负荷的匹配度 | 🎯 发电负荷越匹配越好 | 20% |

### 指标计算详解

#### 1. 负载平衡度 (Load Balance)
- **物理意义**：各分区的负荷分布是否均匀
- **计算方法**：变异系数（CV = 标准差/平均值）
- **取值范围**：[0, +∞)，越小越好
- **智能优化**：系统自动适配不同网络规模的评估标准
- **实际示例**：
  ```
  假设3个分区的负荷分别为：[100MW, 120MW, 80MW]
  平均值 = 100MW，标准差 = 16.33MW
  负载平衡度 = 16.33/100 = 0.163
  ```

#### 2. 电气解耦率 (Electrical Decoupling)
- **物理意义**：分区间的电气连接强度
- **计算方法**：跨分区导纳总和 / 网络总导纳
- **取值范围**：[0, 1]，越小越好
- **技术升级**：使用pandapower官方转换器确保导纳计算精度
- **实际示例**：
  ```
  假设网络总导纳为1000S，跨分区导纳为150S
  电气耦合率 = 150/1000 = 0.15
  ```

#### 3. 功率平衡度 (Power Balance)
- **物理意义**：分区内发电与负荷的匹配程度
- **计算方法**：|发电-负荷|的和 / 总负荷
- **取值范围**：[0, +∞)，越小越好
- **智能评估**：自动识别不同网络的发电配置特点
- **实际示例**：
  ```
  分区1：发电150MW，负荷100MW，差值50MW
  分区2：发电80MW，负荷120MW，差值40MW
  分区3：发电70MW，负荷80MW，差值10MW
  功率不平衡 = (50+40+10)/300 = 0.33
  ```

---

## 📊 评分系统与提升率计算

### 评分转换（智能归一化）
系统采用智能归一化方法，将原始指标转换为"越大越好"的分数：

| 原始指标 | 转换公式 | 分数范围 | 优化特点 |
|---------|----------|----------|----------|
| 负载平衡度 | `Score = 1/(1 + CV)` | (0, 1] | 自适应网络规模 |
| 电气解耦率 | `Score = 1 - 耦合率` | [0, 1] | 高精度导纳计算 |
| 功率平衡度 | `Score = 1/(1 + 不平衡率)` | (0, 1] | 发电配置感知 |

### 综合评分（场景感知）
使用场景感知加权平均计算最终质量分数：
```
综合分数 = 0.4 × 负载平衡分数 + 0.4 × 电气解耦分数 + 0.2 × 功率平衡分数
```

### 提升率计算方法

**提升率** = (智能体分数 - 基线分数) / 基线分数 × 100%

**具体示例**：
```
场景：IEEE-118网络，N-1故障条件
- 我们的智能体综合分数：0.78
- 谱聚类方法综合分数：0.62
- 提升率 = (0.78 - 0.62) / 0.62 × 100% = 25.8%

解读：在大规模网络故障场景下，我们的方法比谱聚类好25.8%
```

**场景感知分析**：
- **正常运行**：通常提升率较高（30-50%）
- **故障条件**：考验智能体的鲁棒性（15-30%）
- **负荷扰动**：测试适应性能力（20-40%）

---

## 🔄 测试流程详解

### 1. 测试场景生成（智能化）
系统会根据网络规模智能生成适配的测试场景：

| 场景名称 | 场景描述 | 生成方式 | 适用网络 |
|---------|----------|----------|----------|
| **normal** | 正常负荷条件 | 使用原始网络数据 | 所有网络 |
| **high_load** | 高负荷条件 | 负荷增加30-50% | 所有网络 |
| **unbalanced** | 负荷不均衡 | 智能不均衡生成 | 中大型网络 |
| **fault** | N-1故障 | 智能选择关键线路 | 所有网络 |

### 2. 方法对比（全面升级）
每个场景下测试4种方法，所有方法均使用相同的数据源：

| 方法名称 | 说明 | 类型 | 技术特点 |
|---------|------|------|----------|
| **my_agent** | 场景感知强化学习智能体 | 🤖 AI方法 | HybridRewardFunction |
| **random** | 随机分区 | 📊 基线方法 | 统计学基准 |
| **spectral** | 谱聚类方法 | 📊 传统方法 | 图论算法 |
| **kmeans** | K-means聚类 | 📊 传统方法 | 机器学习 |

### 3. 重复实验（统计可靠性）
- 每种方法在每个场景下运行 **20次**（已优化）
- 使用统计学方法分析置信区间
- 自动检测异常值并提供可靠性评估

---

## 📈 结果解读指南

### 可视化图表说明（升级版）
生成的图表采用现代化设计，包含8个子图：

**上排4图（性能分数，越高越好）**：
1. 负载平衡分数对比（场景感知）
2. 电气解耦分数对比（高精度计算）
3. 功率平衡分数对比（智能评估）
4. 综合质量分数对比（加权评分）

**下排4图（原始指标与分析）**：
1. 负载平衡度（CV值分布）
2. 电气耦合率（导纳精度）
3. 功率不平衡率（场景对比）
4. 置信区间分析（统计可靠性）

### 报告文件解读（详细分析）
`evaluation_report.txt` 包含全面的分析结果：

```
==== 电力网络分区性能评估报告 ====
网络规模: IEEE-118 (118节点, 186线路)
测试时间: 2025-01-07 16:00:00
数据来源: pandapower官方转换器

方法名称    场景      负载CV   耦合率   功率不平衡   综合分数   提升率   置信区间
my_agent   normal    0.08     0.12     0.06        0.85      42.3%   ±0.03
spectral   normal    0.15     0.22     0.12        0.60      基准     ±0.02
...

场景感知分析:
- 正常运行: Agent表现优异，提升率40%+
- 故障条件: 展现良好鲁棒性，提升率25%+
- 负荷扰动: 适应性强，提升率35%+
```

### 性能判断标准（动态评估）

#### 基于网络规模的评估标准：
| 网络规模 | 优秀 | 良好 | 一般 | 需改进 |
|---------|------|------|------|--------|
| **小型(≤30节点)** | 分数>0.85 | 分数>0.75 | 分数>0.65 | 分数<0.65 |
| **中型(31-60节点)** | 分数>0.80 | 分数>0.70 | 分数>0.60 | 分数<0.60 |
| **大型(61+节点)** | 分数>0.75 | 分数>0.65 | 分数>0.55 | 分数<0.55 |

#### 场景感知评估：
- **正常场景**：基准性能测试
- **故障场景**：鲁棒性验证
- **扰动场景**：适应性评估

---

## ⚙️ 高级配置

### 命令行自定义测试
系统支持精细化测试控制：

```bash
# 快速性能验证（推荐新用户）
python test.py --quick

# 指定网络规模测试
python test.py --network ieee118 --scenarios normal fault --runs 15

# 完整基线对比（适合研究）
python test.py --baseline --network ieee57 --runs 25

# 跨网络泛化测试
python test.py --generalization --episodes 10
```

### 高级参数配置：

- **`--network <网络>`**：指定测试网络（ieee14/30/57/118）
- **`--scenarios <场景列表>`**：选择测试场景
- **`--runs <次数>`**：重复实验次数
- **`--episodes <轮数>`**：每次实验的回合数
- **`--confidence <水平>`**：置信区间水平（默认0.95）

### 配置文件优化
```yaml
# 评估系统配置
evaluation:
  num_episodes: 20           # 默认episodes数
  include_baselines: true    # 包含基线方法
  baseline_methods: ['spectral', 'kmeans']  # 基线方法列表
  metrics_to_track: [        # 跟踪指标
    'episode_reward',
    'episode_length', 
    'cv',
    'coupling_ratio',
    'connectivity',
    'success_rate',
    'robustness_score'
  ]

# 统计分析配置
statistics:
  confidence_level: 0.95     # 置信水平
  outlier_detection: true    # 异常值检测
  min_samples: 10           # 最小样本数
```

---

## 🚨 常见问题与解决方案

### Q1: 为什么某些场景下提升率较低？
**A**: 这反映了不同方法的适用场景差异。我们的智能体在复杂场景下优势更明显，简单场景下传统方法也可能表现良好。

### Q2: 如何解释置信区间？
**A**: 置信区间表示统计可靠性。区间越窄说明结果越稳定，重叠较少说明方法间差异显著。

### Q3: GPU加速对测试有帮助吗？
**A**: 是的。启用GPU可将测试速度提升3-5倍，特别是在大规模网络测试中。

### Q4: 如何处理"数据来源不一致"警告？
**A**: 确保所有方法使用相同的pandapower转换器数据。运行前清理缓存：`rm -rf data/cache/`

### Q5: 测试结果如何与论文数据对比？
**A**: 使用相同的网络配置和评估指标。注意我们使用的是归一化评分系统，更适合跨网络对比。

---

## 🔧 系统维护与升级

### 文件结构（优化后）
```
evaluation_results/
├── comparison_visualization.png    # 传统对比图表
├── evaluation_report.txt          # 详细文本报告
├── statistical_analysis.json      # 统计分析数据
└── confidence_intervals.png       # 置信区间可视化

output/dashboards/
├── evaluation_interactive.html    # 交互式评估仪表板
└── performance_analysis.html      # 性能分析报告
```

### 技术升级记录
- ✅ **数据源统一**：迁移至pandapower官方转换器
- ✅ **评估精度提升**：高精度导纳计算
- ✅ **统计可靠性**：置信区间分析
- ✅ **场景感知**：智能场景分类和评估
- ✅ **网络兼容性**：支持IEEE14/30/57/118

### 未来改进方向
1. **实时交互**：Web界面的实时测试监控
2. **更多基线**：集成更多传统电力系统分区方法
3. **鲁棒性测试**：更复杂的故障场景和扰动测试
4. **自动调参**：智能优化测试参数配置

---

## 🎯 最佳实践建议

### 开发阶段测试流程
1. **快速验证**：`python test.py --quick`
2. **功能测试**：`python test.py --baseline --network ieee30`
3. **性能评估**：`python test.py --comprehensive --network ieee118`

### 研究发布前检查清单
- [ ] 所有IEEE网络测试通过
- [ ] 置信区间分析完成
- [ ] 基线方法对比充分
- [ ] 异常场景测试覆盖
- [ ] 统计显著性验证

### 故障排除指南
```bash
# 检查数据一致性
python -c "from train import load_power_grid_data; print('✅ Data OK')"

# 验证模型加载
python test.py --quick --episodes 1

# 清理并重新测试
rm -rf data/cache/ evaluation_results/
python test.py --quick
```

---

**🚀 推荐快速开始:**
```bash
python test.py --quick
```

> 💡 **提示**: 首次运行建议使用`--quick`模式进行快速验证，确认系统正常后再进行完整评估。